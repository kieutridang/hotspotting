!function(){"use strict";function t(){function t(t,a){$=t,L=$.raisedLand(),f=$.size()||a[0].clientWidth||M,d3.select(window).on("resize",g.bind(null,a)),y=d3.geo.orthographic().translate([f/2,f/2]).center([0,0]).precision(.5),h=d3.select(a[0]).append("svg").attr({"class":"m2s-globe",width:f,height:f}),b=d3.geo.path().projection(y),y.scale(f/2.3).clipAngle(90),A=h.append("g").attr("class","m2s-globe-land-group"),k=A.append("path").datum({type:"Sphere"}).attr("class","m2s-globe-water").attr("fill",z).attr("d",b),$.graticule()!==!1&&(w=A.selectAll("path.m2s-globe-land-group").data(d3.geo.graticule().lines()).enter().append("path").attr({fill:"none",stroke:F,"stroke-opacity":.5,"class":"m2s-globe-graticule"})),$.$watch("mapData",e),$.$watch("points",n,!0),$.$watch("draggable",o),$.$watch("sensitivity",o),$.$watch("clickable",c),$.$watch("rotate",d),$.$watch("rotateAngle",u)}function e(t){if(!t&&mapData){var e=$.mapType||"land";t=topojson.feature(mapData,mapData.objects[e])}t?(d3.selectAll(".m2s-globe-land").remove(),L!==!1&&(D=A.append("path").datum(t).attr("class","m2s-globe-land m2s-globe-shadow").style({"-webkit-filter":"blur(6px)",filter:"blur(6px)",opacity:.4}),x=A.append("path").datum(t).attr("fill",j).attr("class","m2s-globe-land m2s-globe-land-bottom")),S=A.append("path").datum(t).attr("fill",F).attr("class","m2s-globe-land m2s-globe-land-top"),i()):d3.selectAll(".m2s-globe-land").remove()}function n(t){t=t||[];var e=[];angular.forEach(t,function(t){t.values&&t.values.length&&(e=e.concat(t.values.map(r)))}),v=h.selectAll(".m2s-globe-points").data(e),v.enter().append("path").attr({opacity:function(t,e){return l("enter",t,e)>0?0:1}}).transition().ease($.enterAnimEase()||W).delay(function(t,e){return l("enter",t,e)||0}).duration(function(t,e){return s("enter",t,e)||T}).attr("opacity",1),v.attr({fill:a($.pointFill,E),stroke:a($.pointStroke,C),"stroke-width":a($.pointStrokeWidth,R)}).attr("id",function(t){return t.id}).attr("class",function(t){return a($.pointClass)(t)+" m2s-globe-points"}),c($.clickable),v.exit().transition().ease($.exitAnimEase()||W).delay(function(t,e){return l("exit",t,e)||0}).duration(function(t,e){return s("exit",t,e)||T}).attr("opacity",0).remove(),i()}function a(t,e){return function(n){return t({d:n.properties})||e}}function i(){y.scale(f/2.3).clipAngle(90),$.graticule()!==!1&&w.attr("d",b),L!==!1&&(D&&D.attr("d",b),y.scale(f/2.2).clipAngle(106.3),x&&x.attr("d",b),y.scale(f/2.2).clipAngle(90)),S&&S.attr("d",b),h.selectAll(".m2s-globe-points").attr("d",function(t){return b.pointRadius(a($.pointRadius,I)(t))(t)})}function r(t){return{type:"Feature",id:a($.pointId,m())({properties:t}),properties:t,geometry:{type:"Point",coordinates:[a($.pointLng)({properties:t}),a($.pointLat)({properties:t})]}}}function o(){var t=$.draggable(),e=$.sensitivity()||.25;t?A.call(d3.behavior.drag().origin(function(){var t=y.rotate();return{x:t[0]/e,y:-t[1]/e}}).on("drag",function(){var t=y.rotate();y.rotate([d3.event.x*e,-d3.event.y*e,t[2]]),i()})):A.on("dragstart",null).on("drag",null).on("dragend",null)}function l(t,e,n){return $[t+"AnimDelay"]({d:e,i:n})||0}function s(t,e,n){return $[t+"AnimDuration"]({d:e,i:n})||0}function c(t){t()===!1?(v.style("cursor","normal"),v.on("click",null)):(v.style("cursor","pointer"),v.on("click",p))}function p(t){var e=[a($.pointLng)(t),a($.pointLat)(t)],n=d3.select("#"+t.id);$.$apply(function(){$.pointClick({d:t.properties,c:y(e),el:n})})}function d(){$.rotate()&&d3.timer(function(){var t=$.rotateSpeed()||0===$.rotateSpeed()?$.rotateSpeed():1;return y.rotate([t/100*(Date.now()-G),-15]),i(),!$.rotate()})}function u(t){t=t(),t&&2===t.length&&y.rotate([t[0],t[1]])}function g(t){$.size()||(f=t[0].clientWidth||M,h.attr({width:f,height:f}),y.translate([f/2,f/2]).scale(f/2.3).clipAngle(90),k.attr("d",b),i())}function m(){function t(){return Math.floor(65536*(1+Math.random())).toString(16).substring(1)}return"point-"+t()}var f,h,b,y,v,A,k,w,D,x,S,$,L,E="#8D6E63",F="#dadac4",j="#737368",z="#FFF",C="#000",W="cubic",R=0,I=5,M=400,T=250,G=new Date;return{link:t,restrict:"EA",scope:{points:"=",mapData:"=",mapType:"@",size:"&",pointStroke:"&",pointFill:"&",pointClass:"&",pointId:"&",pointLat:"&",pointLng:"&",pointRadius:"&",pointStrokeWidth:"&",graticule:"&",draggable:"&",sensitivity:"&",clickable:"&",pointClick:"&",raisedLand:"&",rotate:"&",rotateSpeed:"&",rotateAngle:"&",enterAnimDuration:"&",exitAnimDuration:"&",enterAnimDelay:"&",exitAnimDelay:"&",enterAnimEase:"&",exitAnimEase:"&"}}}angular.module("madvas.angular-globe",[]).directive("m2sGlobe",t),t.$inject=[]}();